{% extends 'base.html' %}  
{% load custom_filters %}
{% block content %}  
<div class="container mt-4"> 
    <div class="row"> 
        <div class="col-12">  
            <div class="d-flex justify-content-between align-items-center mb-4"> 
                <h1 class="h2 text-dark">ðŸ›’ Mi Carrito de Compras</h1>  <!-- Titulo del carrito -->
                <a href="{% url 'home' %}" class="btn btn-outline-primary">  <!-- Boton para seguir comprando -->
                    <i class="fas fa-arrow-left me-2"></i>Seguir Comprando  
                </a>
            </div> 

            {% if carrito_items %}  
            <div class="card shadow">  
                <div class="card-body">  
                    <div class="table-responsive">  
                        <table class="table table-hover"> 
                            <thead class="table-light"> 
                                <tr>  <!-- Fila de encabezados -->
                                    <th>Servicio</th>
                                    <th>Precio Unitario</th> 
                                    <th>Cantidad</th> 
                                    <th>Subtotal</th> 
                                    <th>Acciones</th>  
                                </tr>
                            </thead>
                            <tbody> 
                                {% for item in carrito_items %} 
                                <tr> 
                                    <td>  <!-- Celda del servicio -->
                                        <strong class="text-dark">{{ item.servicio.nombre }}</strong>  <!-- Nombre del servicio -->
                                        <br>  <!-- Salto de linea -->
                                        <small class="text-muted">{{ item.servicio.descripcion }}</small>  <!-- Descripcion del servicio -->
                                    </td>
                                    <td class="align-middle">Q{{ item.servicio.precio }}</td>  <!-- Precio unitario -->
                                    <td class="align-middle">  <!-- Celda de cantidad -->
                                        <div class="input-group input-group-sm" style="width: 120px;">  <!-- Grupo de entrada para cantidad -->
                                            <input type="number" class="form-control text-center" 
                                                   value="{{ item.cantidad }}" min="1" 
                                                   onchange="actualizarCantidad({{ item.id }}, this.value)">  <!-- Entrada para cambiar cantidad -->
                                        </div>
                                    </td>
                                    <td class="align-middle"> 
                                        <strong class="text-dark">Q{{ item.servicio.precio|floatformat:2 }}</strong>  
                                    </td>
                                    <td class="align-middle">  
                                        <a href="{% url 'citas:eliminar_del_carrito' item.id %}" 
                                           class="btn btn-outline-danger btn-sm" 
                                           onclick="return confirm('Â¿EstÃ¡s seguro de eliminar este servicio del carrito?')">  
                                            <i class="fas fa-trash"></i> Eliminar  <!-- Icono eliminar -->
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}  
                            </tbody>
                        </table>
                    </div>

                    <div class="row mt-4"> 
                        <div class="col-md-6 offset-md-6"> 
                            <div class="card border-0 bg-light">  
                                <div class="card-body"> 
                                    <h5 class="card-title">Resumen del Pedido</h5>      <!-- Titulo del resumen -->
                                    <div class="d-flex justify-content-between mb-2"> 
                                        <span>Subtotal:</span>                          <!-- Etiqueta subtotal -->
                                        <span>Q{{ total|floatformat:2 }}</span>         <!-- Valor subtotal -->
                                    </div>
                                    <div class="d-flex justify-content-between mb-2"> 
                                        <span>Impuestos (12%):</span>                          <!-- Etiqueta impuestos -->
                                        <span>Q{{ total|multiply:0.12|floatformat:2 }}</span>  <!-- Valor impuestos -->
                                    </div>
                                    <hr> 
                                    <div class="d-flex justify-content-between">  <!-- Linea de total -->
                                        <strong>Total:</strong>  <!-- Etiqueta total -->
                                        <strong>Q{{ total|multiply:1.12|floatformat:2 }}</strong>  <!-- Valor total con impuestos -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">  
                        <a href="{% url 'citas:agendar_cita' %}" class="btn btn-primary">  <!-- Boton agendar cita -->
                            <i class="fas fa-calendar-check me-2"></i>Agendar Cita 
                        </a>
                    </div>
                </div>
            </div>
            {% else %} 
            <div class="card shadow text-center py-5">  
                <div class="card-body">  
                    <i class="fas fa-shopping-cart fa-4x text-muted mb-3"></i> 
                    <h3 class="text-dark">Tu carrito estÃ¡ vacÃ­o</h3>  <!-- Mensaje de carrito vacio -->
                    <p class="text-muted mb-4">Agrega algunos servicios veterinarios para continuar.</p>  <!-- Texto explicativo -->
                    <a href="{% url 'home' %}" class="btn btn-primary btn-lg">  <!-- Boton para ir al home -->
                        <i class="fas fa-paw me-2"></i>Explorar Servicios  
                    </a>
                </div>
            </div>
            {% endif %} 
        </div>
    </div>
</div>

<script>  <!-- Inicio de script JavaScript -->
function actualizarCantidad(itemId, nuevaCantidad) {  
    fetch(`{% url 'citas:actualizar_cantidad' 0 %}`.replace('0', itemId), {  
        method: 'POST',                                 // Metodo POST
        headers: {
            'X-Requested-With': 'XMLHttpRequest', 
            'X-CSRFToken': '{{ csrf_token }}',          // Token CSRF para seguridad
        },
        body: new URLSearchParams({  
            'cantidad': nuevaCantidad  
        })
    })
    .then(response => response.json())                  // Convierte respuesta a JSON
    .then(data => {                                     // Procesa la respuesta
        if (data.success) {                             // Si la actualizacion fue exitosa
            location.reload();                          // Recarga la pagina para actualizar totales
        } else {                                        // Si hubo error
            alert('Error al actualizar cantidad: ' + data.error);  
        }
    })
    .catch(error => {                                   // Si hay error en la peticion
        console.error('Error:', error);                 
        alert('Error de conexiÃ³n');                     // Muestra alerta de error
    });
}
</script> 
{% endblock %} 